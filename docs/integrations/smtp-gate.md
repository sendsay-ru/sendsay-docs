---
sidebar_position: 1
sidebar_label: 'Отправка через SMTP-гейт'
---

# Отправка рассылок через SMTP-гейт

## Что такое SMTP-гейт

SMTP-гейт – это способ передачи нам заданий на отправку писем через [SMTP-протокол](https://ru.wikipedia.org/wiki/SMTP). Если ваша система, которой нужно отправлять письма, уже умеет это делать через SMTP, использование SMTP-гейта существенно упростит интеграцию с Sendsay.

Отправка рассылок через SMTP-гейт обладает существенными ограничениями по сравнению с отправкой через Sendsay API.

## Как подключить SMTP-гейт

Для получения доступа к SMTP-гейту напишите в поддержку или вашему менеджеру. Вам зададут несколько вопросов о ваших рассылках и после этого выдадут параметры подключения.

Авторизация возможна как по логину-паролю, так и через закрепление IP-адресов, с которых будет происходить соединение и отправка писем.

Доступ к SMTP-гейту осуществляется через стандартный порт 25. Если вам требуется TLS-соединение, то вы также можете использовать 25-й порт, либо 587-й.

## Тестирование SMTP-гейта

Если у вас уже есть доступ к SMTP-гейту, вы можете отправлять письма на test@test.ru, они будут приниматься и игнорироваться. В статистике они также не появятся.

Если у вас нет еще доступа к SMTP-гейту, для тестирования соединения можно использовать следующие настройки:

- **Хост** — demo.gate.sendsay.ru
- **Логин** — demo.demo@smtpgate
- **Пароль** — demo

Письма, отправленные на любые адреса, уходить не будут.

## Email-аутентификация

Письма, отправляемые через SMTP-гейт, могут дополняться DKIM-подписью вашего домена. Для этого просто добавьте один или несколько доменов через личный кабинет.

Соответствующий домен для формирования DKIM-подписи будет выбираться в зависимости от домена адреса отправителя. Если подходящего домена не найдётся, то будет использован домен по умолчанию (при наличии такового).

Так как мы не изменяем используемый во входящей SMTP-сессии MAIL FROM, вы должны у домена, используемого в MAIL FROM, добавить нашу SPF-запись в настройках ДНС:

```
v=spf1 include:spf.sendsay.ru ~all
```

## Статистика рассылок через SMTP-гейт

Все письма, отправленные через SMTP-гейт, объединяются в выпуски в рамках суток. По каждому отправленному письму доступны все типы откликов: доставка, открытия, клики, отписки.

### X-Campaign-Id

Если вы хотите объединять в статистике письма по заранее известному признаку (например, по цели отправки), можно использовать email header `X-Campaign-Id`. Его значение может состоять из латинских букв, цифр и символов "\_" и "-".

Значение `X-Campaign-Id` будет назначено параметру issue.name

### X-Letter-Id

Также каждому отправленному письму можно присвоить собственный идентификатор, используя email header `X-Letter-Id`. Его значение может состоять из латинских букв, цифр и символов "\_" и "-".

Значение `X-Letter-Id` будет возвращено в коллбэках в параметре `gate.uniq`.

## Особенности отправки рассылок через SMTP-гейт

Отправляемое к нам письмо должно содержать указанные ниже заголовки, так как они участвуют в формировании DKIM-подписи. В случае их отсутствия письмо примется и молча погибнет.

```
Message-Id
Date
From
To
Subject
MIME-Version
Content-Type
```

## Ошибки при отправке через SMTP-гейт

Успешная SMTP-сессия прошла и принятие нами задания не гарантирует отправки письма адресату. При отправке могут возникать разные коды ответов — каждый имеет свой SMTP-код из&nbsp;3&nbsp;цифр. Если знать значение кодов, можно разобраться в&nbsp;причинах их&nbsp;появления.

### Значения первой цифры SMTP-кода

Первая цифра указывает на&nbsp;то, был&nbsp;ли принят и&nbsp;обработан запрос.

**1yz** Сервер принял команду, но&nbsp;ожидает подтверждения на&nbsp;продолжение или отказ от&nbsp;выполнения запрошенных действий.

**2yz** DSN сообщает об&nbsp;успешной доставке, сервер готов принимать новую команду.

**3yz** Сервер воспринял команду, но&nbsp;отложил необходимое действие до&nbsp;получения дополнительной информации.

**4yz** Временный сбой, при котором отправленное письмо валидно. Но&nbsp;из-за наличия каких-то временных условий возник отказ или задержка при попытке отправить письмо.

**5yz** Постоянный сбой. Даже если повторно отправить сообщение, вряд&nbsp;ли ошибка будет устранена.

### Значения второй цифры SMTP-кода

Вторая цифра уточняет тип ответа.

**x0z** Синтаксические ошибки.

**x1z** Ответы на&nbsp;запросы информации

**x2z** Ошибки канала передачи данных.

**x3z** Неизвестная ошибка.

**x4z** Неизвестная ошибка.

**x5z** Статус почтовой системы.

### Распространенные коды ответов SMTP&nbsp;200

**214** Справочное сообщение о&nbsp;работе с&nbsp;сервером.

**220** SMTP-сервер готов к&nbsp;выполнению следующей команды.

**221** Соединение с&nbsp;почтовым сервером завершается.

**250** Запрошенное почтовое действие завершено.

**251** Нелокальный пользователь, сервер переотправит письмо.

**252** Письмо было доставлено корректно, есть положительная запись об&nbsp;адресе электронной почты. Но&nbsp;скорее всего, письмо не&nbsp;находится на&nbsp;почтовом сервере и&nbsp;удерживается до&nbsp;проверки.

### Распространенные коды ответов SMTP&nbsp;400

**421** Временная проблема у&nbsp;почтового сервера или учетной записи электронной почты получателя. Причины:

- слишком много соединений с&nbsp;вашего хоста,
- сервер занят и&nbsp;не&nbsp;может принять соединение,
- сервис временно недоступен.

**450** Ошибка вызвана из-за проблем с&nbsp;DNS-маршрутизацией на&nbsp;SMTP-сервере получателя, если:

- cервер получателя не&nbsp;может найти адрес электронной почты на&nbsp;своем сервере,
- почтовый сервер получателя отклонил ваш запрос, так как содержимое письма не&nbsp;прошло через его фильтр,
- IP-адрес вашего почтового сервера занесен в&nbsp;черный список.

**451** Запрошенное действие прервано: возникла локальная ошибка при обработке.

**452** Ошибка возможна при попытке отправить одновременно много писем или при добавлении большого количества получателей в&nbsp;одно письмо. В&nbsp;итоге все это может привести к&nbsp;перегрузке SMTP-сервера и&nbsp;нехватке места.

### Распространенные коды ответов SMTP&nbsp;500

**500** Синтаксическая ошибка, используемая команда SMTP не&nbsp;распознается или она слишком длинная, или не&nbsp;поддерживается принимающим SMTP-сервером.

**501** Синтаксическая ошибка в&nbsp;параметрах или аргументах. Письмо было отправлено на&nbsp;неправильный адрес электронной почты, некорректное доменное имя или на&nbsp;адрес, который не&nbsp;соответствует спецификации RFC 2821.

Еще возможные причины этой ошибки&nbsp;&mdash; антивирусная защита сбрасывает ваше SMTP-соединение, или если SMTP-команда превышает 512&nbsp;символов.

**502** Команда не&nbsp;реализована.

**503** Неверная последовательность команд на&nbsp;сервере.

**504** Параметр команды не&nbsp;реализован.

**510** Электронная почта получателя в&nbsp;поле &laquo;To&raquo;, &laquo;Cc&raquo; или &laquo;Bcc&raquo; не&nbsp;существует или некорректна.

**512** Домен электронной почты получателя не&nbsp;найден или не&nbsp;существует.

**513** Недействительный адрес электронной почты или адреса содержат не&nbsp;поддерживаемый синтаксис.

**515** Неверный или несуществующий адрес электронной почты, возможно из-за неправильного написания.

**523** Размер письма превысил лимиты почтового сервера получателя.
Эти лимиты устанавливаются сервером электронной почты и&nbsp;позволяют принимать письма только определенного размера.

**530** Сервер требует аутентификацию. Или в&nbsp;редких случаях сбой может быть из-за IP-адреса, который находится в&nbsp;черном списке.

**531** Почтовый сервер получателя переполнен и&nbsp;не&nbsp;может принимать письма.

**534** Слабая система аутентификация клиента, сервер требует более сильной аутентификации, чтобы принять соединение.

**535** Проблема с&nbsp;аутентификацией клиента на&nbsp;сервере электронной почты. Распространенные причины этой проблемы&nbsp;&mdash; недействительные учетные данные, отключенная учетная запись, неверные или несовместимые настройки методов аутентификации.

**541** Почтовый сервер получателя отклоняет письмо. Возможные причины:

- письмо похоже на&nbsp;спам,
- плохая репутация IP-адреса,
- IP-адрес занесен в&nbsp;черный список,
- cистема фильтрации спама ложно срабатывает при обнаружении спама.

**550** Запрошенное действие не&nbsp;выполнено: почтовый ящик недоступен/не найден, или сервер отклонил письмо из-за подозрения на&nbsp;спам.

**551** Нелокальный пользователь.

**552** Письмо не&nbsp;отправлено&nbsp;&mdash; не&nbsp;хватает места в&nbsp;почтовом ящике получателя.

**553** Требуемые действия не&nbsp;выполнены из-за недопустимого почтового ящика. Это может быть из-за синтаксической ошибки в&nbsp;имени ящика.

**554** Почтовый сервер не&nbsp;принял письмо.&nbsp;7&nbsp;возможных причин этого:

- недействительный адрес получателя,
- IP-адрес отправителя может быть заблокирован, возможно из-за массовых писем или рассылку спама,
- неправильные DNS-записи, из-за чего почтовый сервер получателя отклоняет электронную почту из-за проблем, которые он&nbsp;может увидеть в&nbsp;DMARC, SPF и&nbsp;DKIM почтового сервера для проверки отправителя.
- получатель настроил SPF (Sender Policy Framework) для отсеивания нежелательных спам-доменов,
- не&nbsp;настроена DKIM-запись или DMARC-запись,
- адрес электронной почты или домен отправителя помечены как спам,
- нарушены правила безопасности электронной почты и&nbsp;не&nbsp;соблюден определенный набор критериев, которые устанавливает поставщик услуг электронной почты.

**555** Параметры &laquo;MAIL&nbsp;FROM&raquo; /&laquo;RCPT&nbsp;TO&raquo; не&nbsp;распознаны или не&nbsp;реализована.

### Проблемы с адресом получателя

550 5.0.0 Email has permanent delivery errors <br/>
550 5.0.0 Email is in the account stoplist <br/>

### Проблемы с формированием письма

635 6.7.8 issue is blocked <br/>
635 6.7.8 error/sender/unknown <br/>
635 6.7.8 error/sender/onmoderation <br/>
635 6.7.8 error/sender/prohibited <br/>
635 6.7.8 no To: <br/>
635 6.7.8 no From: <br/>
635 6.7.8 no Subject: <br/>
635 6.7.8 no email in From: <br/>

Посмотреть 100 последних ошибок в SMTP-гейте можно в АПИ-консоли с помощью запроса:

<!-- prettier-ignore -->
```js
{
	"filter": [{
		"a": "delivstream.status",
		"v": "bounced",
		"op": "=="
	}, {
		"a": "delivstream.source",
		"op": "==",
		"v": "1"
	}],
	"action": "stat.uni",
	"select": ["delivstream.to", "delivstream.dt", "delivstream.msg"],
	"first": 100,
	"order": ["-delivstream.dt"]
}
```
